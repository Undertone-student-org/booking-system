name: Lint Codebase
permissions:
  contents: write
  statuses: write 
on:
    workflow_call:
jobs:
  super-linter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
            fetch-depth: 0
      - name: Run Super-Linter
        uses: super-linter/super-linter@v8
        env:
            VALIDATE_ALL_CODEBASE: true
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            OUTPUT_DETAILS: detailed
            DISABLE_ERRORS: true
            SAVE_SUPER_LINTER_OUTPUT: true
      - name: Generate Clean Super-Linter Markdown summary
        run: |
          OUTPUT_DIR="super-linter-output/super-linter/"
          MDREPORT="super-linter-report.md"
          echo "# Super-Linter Results" > "$MDREPORT"
          echo "| Linter | Status |" >> "$MDREPORT"
          echo "|--------|--------|" >> "$MDREPORT"
          for codefile in $OUTPUT_DIR/super-linter-parallel-command-exit-code-*; do
            linter=$(basename "$codefile" | sed 's/super-linter-parallel-command-exit-code-//')
            code=$(cat "$codefile")
            if [ "$code" = "0" ]; then
              echo "| $linter | ✅ Passed |" >> "$MDREPORT"
            else
              echo "| $linter | ❌ Failed |" >> "$MDREPORT"
              errfile="$OUTPUT_DIR/super-linter-parallel-stderr-$linter"
              if [ -f "$errfile" ]; then
                echo "<details><summary>$linter errors</summary>" >> "$MDREPORT"
                echo '' >> "$MDREPORT"
                echo '```' >> "$MDREPORT"
                # Remove ANSI color codes
                sed 's/\x1b\[[0-9;]*m//g' "$errfile" >> "$MDREPORT"
                echo '```' >> "$MDREPORT"
                echo "</details>" >> "$MDREPORT"
                echo '' >> "$MDREPORT"
              fi
            fi
          done
          echo "" >> "$MDREPORT"
      - name: Insert Super-Linter report into README.md and push
        run: |
          # Insert the linter report between the markers
          awk -v report="$(cat super-linter-report.md)" '
            BEGIN {in_section=0}
            /<!-- SUPER_LINTER_REPORT_START -->/ {print; print report; in_section=1; next}
            /<!-- SUPER_LINTER_REPORT_END -->/ {in_section=0}
            !in_section {print}
          ' README.md > README.new.md
          mv README.new.md README.md

          # Get current branch name
          branch="$(git rev-parse --abbrev-ref HEAD)"

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Add and commit README.md
          git add README.md
          git commit -m "Update Super-Linter report [skip ci]" || echo "No changes to commit"

          # Push logic
          if [ "$branch" = "production" ]; then
            echo "Not pushing to production branch."
          elif [ "$branch" = "pre-production" ]; then
            git push --force
          else
            git push
          fi